<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quan Nguyen</title>
    <link rel="icon" href="/images/logo.png">
    <link id="stylesheet" rel="stylesheet" href="/assets/styte-light.css">
    <link rel="stylesheet" href="/assets/prism.css">
    <link rel="alternate" type="application/rss+xml" title="Quan Nguyen" href="/rss.xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="/assets/style.js"></script>
</head>

<body>
<div class="page-content">
    <div class="home">
        <section class="site-header">
            <h1 class="smallcap">
                <a class="site-title" href="/">Quan Nguyen</a>
            </h1>
            <p class="site-nav">
                <a class="site-nav-el" href="/">cd~</a> /
                <a class="site-nav-el" href="/about">about</a> /
                <a class="site-nav-el" href="/tags">tags</a> /
                <a class="site-nav-el" href="/poem">poem</a> /
                <a class="site-nav-el" href="/rss">rss</a> /
                <a class="site-nav-el theme-switch" onclick="changeTheme('btnClick')"><i id="fa-theme-switch" class="fa fa-sun-o"></i></a>
            </p>
    <h1 class="post-title" itemprop="name headline">Tá»•ng há»£p vÃ i thá»© vá» Apache Kafka</h1>
    <div class="post-meta">
        <div class="post-date">
            <time datetime="2017-01-15T00:00:00+00:00" itemprop="datePublished">21/01/2021</time>
        </div>
        <div class="post-tag">
            <i class="fa fa-tag fa-1x" aria-hidden="true"></i>
                <a class="tag" href="/tags/event-streaming" style="background: #f0db4f">#event-streaming</a>
        </div>
    </div>
        </section>
        <section class="site-body">
    <div class="post-content">
        <blockquote>
<p>Tá»•ng há»£p tá»« nhiá»u nguá»“n</p>
</blockquote>

<h2>Kafka lÃ  gÃ¬?</h2>

<p>Kafka lÃ  <code>event-streaming</code> platform (distributed message platform),
bÃªn publish dá»¯ liá»‡u Ä‘Æ°á»£c gá»i lÃ  proceducer cÃ²n bÃªn subcribe dá»¯ liá»‡u Ä‘Æ°á»£c gá»i lÃ  consumer, trong toÃ n bá»™ há»‡ thá»‘ng,
consumer sáº½ nháº­n dá»¯ liá»‡u theo topic. Kafka cÃ³ kháº£ nÄƒng truyá»n má»™t lÆ°á»£ng message khá»•ng lá»“ theo thá»i gian thá»±c (
millions/sec).
Äá»ƒ Ä‘áº£m báº£o toÃ n váº¹n dá»¯ liá»‡u trong trÆ°á»ng há»£p consumer khÃ´ng subcribe Ä‘Æ°á»£c dá»¯ liá»‡u, Kafka sáº½ lÆ°u láº¡i cÃ¡c message trÃªn
Queue
vÃ  cáº£ trÃªn á»• Ä‘Ä©a Ä‘á»“ng thá»i cÅ©ng replicate cÃ¡c message Ä‘á»ƒ trÃ¡nh máº¥t dá»¯ liá»‡u.</p>

<h2>Má»™t sá»‘ Ä‘áº·c trÆ°ng cá»§a kafka</h2>

<h3>Distributed</h3>

<p>Má»™t distributed system Ä‘Æ°á»£c hiá»ƒu Ä‘Æ¡n giáº£n lÃ  chia thÃ nh cÃ¡c machine lÃ m viá»‡c cÃ¹ng nhau vÃ  trÃªn cÃ¹ng má»™t cluster dÆ°á»›i
dáº¡ng
má»™t nÃºt cho ngÆ°á»i dÃ¹ng cuá»‘i. Distributed trong Kafka Ä‘Æ°á»£c hiá»ƒu theo nghÄ©a lÃ  lÆ°u trá»¯, nháº­n vÃ  gá»­i messages trÃªn cÃ¡c node
khÃ¡c nhau Ä‘Æ°á»£i gá»i lÃ  Broker
( sáº½ nÃ³i sÃ¢u hÆ¡n vá» Broker bÃªn dÆ°á»›i).</p>

<p>Táº¥t nhiÃªn, má»™t Distributed system sáº½ Ä‘Ã¡p á»©ng Ä‘Æ°á»£c kháº£ nÄƒng má»Ÿ rá»™ng vÃ  kháº£ nÄƒng chá»‹u lá»—i cao.</p>

<h3>Horizontal scalable</h3>

<p>NhÆ° Ä‘Ã£ nÃ³i á»Ÿ trÃªn, kháº£ nÄƒng má»Ÿ rá»™ng Ä‘Æ¡n giáº£n chá»‰ lÃ  â€œnÃ©mâ€œ vÃ o nhiá»u machine hÆ¡n, hay trong Kafka lÃ  táº¡o nhiá»u Broker
hÆ¡n,
trÃªn thá»±c táº¿ viá»‡c viá»‡c thÃªm má»™t broker thÃ¬ khÃ´ng khÃ´ng yÃªu cáº§u thá»i gian cháº¿t (downtime)</p>

<h3>Fault tolerant</h3>

<p>Do Kafka lÃ  má»™t Distributed system, nÃªn kháº£ nÄƒng chá»‹u lá»—i lÃ  ráº¥t lá»›n. VÃ­ dá»¥, má»™t cá»¥m Kafka Ä‘Æ°á»£c thiáº¿t káº¿t bá»Ÿi 5 node,
náº¿u trong trÆ°á»ng há»£p leader node down thÃ¬ má»™t trong 4 ná»‘t cÃ²n láº¡i sáº½ lÃªn thay tháº¿ lÃ  leader Ä‘á»ƒ tiáº¿p tá»¥c cÃ´ng viá»‡c.</p>

<p>Má»™t Ä‘iá»u Ä‘Ã¡ng lÆ°u Ã½ lÃ  kháº£ng nÄƒng chá»‹u lá»—i sáº½ Ä‘Æ°á»£c Ä‘Ã¡nh Ä‘á»•i trá»±c tiáº¿p báº±ng hiá»‡u nÄƒng. Má»™t há»‡ thá»‘ng cÃ³ kháº£ nÄƒng chá»‹u lá»—i
thÃ¬ hiá»‡u suáº¥t cÃ ng kÃ©m.</p>

<h3>Commit log</h3>

<p>LÃ  má»™t khÃ¡i niá»‡m cá»‘t lÃµi cá»§a Kafka, Commit log Ä‘Æ°á»£c hÃ¬nh dung lÃ  má»™t data structure chá»‰ cho phÃ©p thÃªm má»›i record vÃ 
khÃ´ng
thá»ƒ xÃ³a vÃ  sá»­a Ä‘á»•i record má»™t khi Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o commit log. Commit log dá»±a trÃªn queue data structure tá»©c Ä‘Æ°á»£c sáº¯p xáº¿p
tá»« trÃ¡i sang pháº£i tá»« trÃ¡i sang pháº£i Ä‘á»ƒ Ä‘áº£m báº£o thá»© tá»± cá»§a events.</p>

<p>Kafka lÆ°u trá»¯ data trÃªn local disk, vÃ  sáº¯p xáº¿p chÃºng trong Commit log giÃºp táº­n dá»¥ng kháº£ nÄƒng tÃ¬m kiáº¿m tuáº§n tá»±. Má»™t sá»‘
lá»£i
Ã­ch cá»§a cáº¥u trÃºc Commit log nhÆ° sau:</p>

<ul>
<li>Äá»c vÃ  ghi trÃªn má»™t khÃ´ng gian khÃ´ng Ä‘á»•i lÃ  O(1) do datas Ä‘Æ°á»£c Æ°u trá»¯ dÆ°á»›i dáº¡ng key value.</li>
<li>Äá»c vÃ  ghi khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n nhau</li>
</ul>

<p>Lá»£i Ã­ch trÃªn cÃ³ Æ°u Ä‘iá»ƒm ráº¥t lá»›n vá»›i lÆ°á»£ng message scale theo thá»i gian, vÃ­ dá»¥ viá»‡c tÃ¬m kiáº¿m trÃªn táº­p 1MB cÅ©ng giá»‘ng nhÆ°
tÃ¬m kiáº¿m trÃªn táº­p 1GB.
<img src="../../../../../images/2020-01-21-kafka-achitech.png" alt="Minion" /></p>

<h2>Má»™t sá»‘ thÃ nh pháº§n cá»§a Kafka</h2>

<h3>Broker</h3>

<ul>
<li><p>LÃ  thÃ nh pháº§n cá»‘t lÃµi cá»§a Kafka</p></li>

<li><p>Duy trÃ¬ topic log vÃ  leader broker vÃ  follower broker cho cÃ¡c partitions Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi ZooKeeper</p></li>

<li><p>Kafka cluster bao gá»“m má»™t hoáº·c nhiá»u broker</p></li>

<li><p>Duy trÃ¬ viá»‡c replicate trÃªn toÃ n bá»™ cluster</p></li>
</ul>

<h3>Producer</h3>

<ul>
<li><p>Publish message tá»›i má»™t hoáº·c nhiá»u topic</p></li>

<li><p>Messages Ä‘Æ°á»£c append vÃ o má»™t trong cÃ¡c chá»§ Ä‘á»</p></li>

<li><p>ÄÆ°á»£c coi lÃ  má»™t user trong 1 Kafka cluster</p></li>

<li><p>Kafka duy trÃ¬ thá»© tá»± cá»§a Message trÃªn má»—i partition chá»© khÃ´ng pháº£i trÃªn toÃ n partition</p></li>
</ul>

<h3>Message</h3>

<ul>
<li><p>Kafka message chá»©a má»™t máº£ng cÃ¡c bytes, ngoÃ i ra nÃ³ cÃ³ má»™t metadata tÃ¹y chá»n Ä‘Æ°á»£c gá»i lÃ  Key.</p></li>

<li><p>Má»™t Message cÃ³ má»™t Key vÃ  Ä‘Æ°á»£c ghi vÃ o má»™t partition cá»¥ thá»ƒ.</p></li>

<li><p>Message cÅ©ng Ä‘Æ°á»£c viáº¿t Ä‘Æ°á»›i dáº¡ng cÃ¡c lÃ´, vÃ  cÃ¡c lÃ´ Ä‘Æ°á»£c nÃ©n láº¡i khi truyá»n qua networking</p></li>

<li><p>ChÃº Ã½ viá»‡c ghi dÆ°á»›i dáº¡ng cÃ¡c lÃ´ sáº½ tÄƒng thÃ´ng lÆ°á»£ng nhÆ°ng cÅ©ng tÄƒng Ä‘á»™ trá»…, do Ä‘Ã³ cáº§n cÃ¢n Ä‘á»‘i Ä‘iá»u nÃ y.</p></li>
</ul>

<h3>Consumer</h3>

<ul>
<li><p>Subcriber message tá»« má»™t topic</p></li>

<li><p>Má»™t hoáº·c nhiá»u Consumer cÃ³ thá»ƒ subcrible má»™t topic tá»« cÃ¡c partition khÃ¡c nhau, Ä‘Æ°á»£c gá»i lÃ  consumer group.</p></li>

<li><p>2 consumer trong cÃ¹ng má»™t Group khÃ´ng thá»ƒ cÃ¹ng subcribe cÃ¡c messages trong cÃ¹ng má»™t partition.</p></li>
</ul>

<h3>Topic</h3>

<ul>
<li><p>CÃ³ thá»ƒ Ä‘Æ°á»£c xem nhÆ° má»™t folder cá»§a file system</p></li>

<li><p>Má»—i message Ä‘Æ°á»£c publish tá»›i topic táº¡i má»™t location cá»¥ thá»ƒ Ä‘Æ°á»£c gá»i lÃ  offset. Äiá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  message Ä‘Æ°á»£c xÃ¡c
Ä‘á»‹nh lÃ  offset number</p></li>

<li><p>Má»—i topic, Kafka cluster sáº½ duy trÃ¬ má»™t file log</p></li>

<li><p>Dá»¯ liá»‡u trÃªn má»—i phÃ¢n vÃ¹ng Ä‘á»u Ä‘Æ°á»£c replicate tá»i nhá»¯ng broker khÃ¡c Ä‘á»ƒ Ä‘áº£m báº£o kháº£ nÄƒng chá»‹u lá»—i</p></li>
</ul>

<h2>Kafka hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?</h2>

<h3>Record flow</h3>

<p><img src="../../../../../images/2021-01-21-kafka-concept/record-flow.jpg" alt="Record flow" /></p>

<p>Khi Producer gá»­i má»™t message lÃªn topic 1 táº¡i partion 4, trÆ°á»ng há»£p partition trá»‘ng, message Ä‘Æ°á»£c ghi vÃ o</p>

<p>partitition nháº­n offset lÃ  0. TÆ°Æ¡ng tá»± Ä‘á»‘i vá»›i cÃ¡c message tiáº¿p theo, offset sáº½ Ä‘Æ°á»£c cáº­p nháº­t tÄƒng dáº§n Ä‘á»‘i vá»›i má»—i
message Ä‘áº§u vÃ o. Kafka Ä‘áº£m báº£o ráº±ng táº¥t cáº£ cÃ¡c message sáº½ Ä‘Æ°á»£c sáº¯p xáº¿p theo thá»© tá»± do Ä‘Ã³ khi má»™t consumer subcribe 1
parition cá»¥ thá»ƒ thÃ¬ cÅ©ng nháº­n Ä‘Æ°á»£c message theo tuáº§n tá»±.</p>

<p>ÄÃ o sÃ¢u hÆ¡n vá» cÃ¡c trÆ°á»ng há»£p cá»¥ thá»ƒ cá»§a kafka.</p>

<blockquote>
<p><em>Trong trÆ°á»ng há»£p nhiá»u producer cÃ¹ng gá»­i message vÃ o cÃ¹ng má»™t topic táº¡i cÃ¹ng má»™t thá»i Ä‘iá»ƒm thÃ¬ kafka xá»­ lÃ½ nhÆ° tháº¿
nÃ o?</em></p>
</blockquote>

<p>Kafka xá»­ lÃ½ Ä‘iá»u nÃ y báº±ng cÃ¡ch táº¥t cáº£ cÃ¡c message cÃ³ cÃ¹ng má»™t event key sáº½ Ä‘Æ°á»£c ghi vÃ o cÃ¹ng má»™t partition.</p>

<p><img src="../../../../../images/2021-01-21-kafka-concept/multiple-producer.jpg" alt="Multiple Produce" /></p>

<h3>Kafka replication</h3>

<p>Dá»¯ liá»‡u trong partitition Ä‘Æ°á»£c sao chÃ©p tá»« <code>N</code> Broker khÃ¡c nhau Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n dá»¯ liá»‡u khi má»™t trong cÃ¡c
broker cháº¿t.</p>

<p>LÆ°u Ã½, trÃªn toÃ n bá»™ thá»i gian xá»­ lÃ½ event, thÃ¬ viá»‡c read/write Ä‘Æ°á»£c thá»±c hiá»‡n trÃªn partition Ä‘Æ°á»£c gá»i lÃ  <code>leader</code>. Khi
dá»¯ liá»‡u Ä‘Æ°á»£c ghi vÃ o partition leader, cÃ¡c partition follower tá»« cÃ¡c broker khÃ¡c cÃ³ nhiá»‡m vá»¥ replicates data má»›i nháº­n Ä‘á»ƒ
Ä‘áº£m báº£o an toÃ n dá»¯ liá»‡u, trÃªn thá»±c táº¿ cÃ¡c parition follower cÅ©ng chá»©a sáºµn dá»¯ liá»‡u Ä‘á»ƒ sáºµn sÃ ng lÃªn lÃ m partition leader
náº¿u nhÆ° vÃ¬ má»™t lÃ½ do nÃ o Ä‘Ã³ mÃ  partition leader dies.</p>

<p><img src="../../../../../images/2021-01-21-kafka-concept/kafka-replication.jpg" alt="Multiple Produce" /></p>

<h3>Zookeeper</h3>

<p>Khi gá»­i má»™t message vÃ o Kafka táº¡i má»™t partition cá»¥ thá»ƒ, Kafka cÃ³ má»™t khÃ¡i niá»‡m lÃ  ZooKeeper giÃºp Ä‘iá»u hÆ°á»›ng message Ä‘áº¿n
Ä‘Ãºng partition leader. Äá»“ng thá»i náº¿u má»™t leader dies, Zookeeper cÃ³ nhiá»‡m vá»¥ chá»n má»™t follower lÃ m leader Ä‘á»ƒ tiáº¿p tá»¥c Ä‘á»c
ghi dá»¯ liá»‡u.</p>

<h3>Consuming data</h3>

<p>NhÆ° Ä‘Ã£ Ä‘á» cáº­p trÆ°á»›c Ä‘Ã³, khÃ¡i niá»‡m Consumer dÃ¹ng Ä‘á»ƒ subcribe data.</p>

<p>Má»™t consumer(khÃ´ng cÃ¹ng thuá»™c má»™t group) thÃ¬ cÃ³ thá»ƒ subcribe tá»« nhiá»u partition khÃ¡c nhau.</p>

<p><img src="../../../../../images/2021-01-21-kafka-concept/consumer.jpg" alt="Multiple Produce" /></p>

<p>TrÆ°á»ng há»£p cÃ³ nhiá»u consumer cÃ¹ng thuá»™c má»™t group, thÃ¬ nguyÃªn táº¯c lÃ  cÃ¡c consumer trong cÃ¹ng má»™t group thÃ¬ khÃ´ng Ä‘Æ°á»£c
subcribe cÃ¹ng má»™t partion trÃªn cÃ¹ng má»™t topic</p>

<p><img src="../../../../../images/2021-01-21-kafka-concept/consumer-group.jpg" alt="Multiple Produce" /></p>

<p>Khi thÃªm má»™t lÆ°á»£ng lá»›n consumer vá»±á»£t quÃ¡ sá»‘ lÆ°á»£ng partition thÃ¬ sáº½ xáº£y ra trÆ°á»ng há»£p consumer khÃ´ng nháº­n Ä‘Æ°á»£c dá»¯ liá»‡u.</p>

<p><img src="../../../../../images/2021-01-21-kafka-concept/consumer3.jpg" alt="Multiple Produce" /></p>

<blockquote>
<p><em>Má»—i Consumer trong má»™t group sáº½ chia sáº» Partition cho nhau. NÃªn khi thÃªm má»™t consumer má»›i vÃ o group, consumer má»›i nÃ y
sáº½ subcribe cÃ¡c message á»Ÿ cÃ¡c partition Ä‘Æ°á»£c chia sáº» trÆ°á»›c Ä‘Ã³.</em></p>
</blockquote>

<h3>Táº¡i sao Kafka láº¡i nhanh?</h3>

<ol>
<li>Äá»™ trá»… tháº¥p trong viá»‡c thao tÃ¡c file</li>
</ol>

<p>Viá»‡c sá»­ dá»¥ng disk thay vÃ¬ Ram sáº½ lÃ  giáº£m tá»‘i Ä‘a chi phÃ­ vá» há»‡ thá»‘ng pháº§n cá»©ng, máº·c dÃ¹ng báº¥t ká»ƒ thao tÃ¡c dá»¯ liá»‡u nÃ o
   trÃªn Ram Ä‘á»u ráº¥t nhanh nhÆ°ng nhÆ°á»£c Ä‘iá»ƒm lÃ  vá» chi phÃ­, khÃ´ng gian lÆ°u trá»¯. Äá»ƒ kháº¯c phá»¥c Ä‘iá»u Ä‘Ã³ Kafka sá»­ dá»¥ng má»™t há»‡
   thá»‘ng <code>filesystem</code> vÃ  <code>caching</code>.</p>

<ol>
<li>KhÃ´ng dÃ¹ng cáº¥u trÃºc trees</li>
</ol>

<p>ThÃ´ng thÆ°á»ng cÃ¡c há»‡ thá»‘ng database sá»­ dá»¥ng cáº¥u trÃºc trees Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u, Ä‘iá»u nÃ y khiáº¿n viá»‡c truy suáº¥t thÃ´ng tin
   máº¥t <code>O(logN)</code> time. VÃ¬ tháº¿ Ä‘á»‘i vá»›i há»‡ thá»‘ng event streaming thÃ¬ queue lÃ  lá»±a chá»n há»£p lÃ½ vÃ¬ tá»‘c Ä‘á»™ truy xuáº¥t dá»¯ liá»‡u
   lÃ  <code>O(1)</code></p>

<ol>
<li>KhÃ´ng copy data khi lÆ°u</li>
</ol>

<p>VÃ¬ khi lÆ°u trá»¯, kafka khÃ´ng tuáº§n tá»± hÃ³a khi lÆ°u thay vÃ¬ Ä‘Ã³, Kafka lÆ°u cÃ¡c message dÆ°á»›i dáº¡ng key-value, Ä‘á»“ng thá»i ná»™i
   dung message Ä‘Æ°á»£c lÆ°u trong file log dÆ°á»›i dáº¡ng binary.</p>

    </div>
        </section>
        <div class="copyright">
            <p id="copyright">
                Copyright &copy;
                2021-
                <script>document.getElementById('copyright').appendChild(document.createTextNode(new Date().getFullYear()))</script>
                ğŸš€ <a href="/">Quan Nguyen</a>
            </p>
            <p style="margin-top: 0">
                <a href="https://github.com/qunv"><i class="fa fa-github"></i></a>
                <a href="https://twitter.com/quannv132"><i class="fa fa-twitter"></i></a>
            </p>
        </div>
    </div>
</div>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

    mermaid.initialize({startOnLoad: true});
</script>
<script src="/assets/prism.js"></script>
<script>
    changeTheme('load')
</script>
</body>
</html>
